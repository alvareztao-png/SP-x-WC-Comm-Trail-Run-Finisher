<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Finisher Poster Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  text-align: center;
  padding: 20px;
}

input, button {
  padding: 10px;
  font-size: 16px;
  margin: 8px;
  font-family: 'Anton', sans-serif;
}

canvas {
  margin-top: 20px;
  max-width: 100%;
  display: none;
}
</style>
</head>

<body>

<h1>Finisher Poster</h1>

<input id="nameInput" placeholder="Full Name">
<br>
<input type="file" id="photoInput" accept="image/*">
<br>
<button onclick="generatePoster()">Generate Poster</button>

<canvas id="canvas" width="1080" height="1350"></canvas>

<script>
let participants = [];
let template = new Image();
template.src = "assets/finisher_template.png";

// Load masterlist
fetch("data/participants.json")
  .then(res => res.json())
  .then(data => participants = data);

// Case-insensitive exact match
function findParticipant(name) {
  return participants.find(p =>
    p.name.trim().toLowerCase() === name.trim().toLowerCase()
  ) || null;
}

function generatePoster() {
  const nameInput = document.getElementById("nameInput").value.trim();
  const photoInput = document.getElementById("photoInput").files[0];

  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  canvas.style.display = "block";

  const match = findParticipant(nameInput);
  const bib = match ? match.bib : "";
  const displayName = match ? match.name.toUpperCase() : "";

  template.onload = () => draw();

  if (template.complete) draw();

  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(template,0,0,canvas.width,canvas.height);

    ctx.textAlign = "left";
    ctx.fillStyle = "#000"; // BLACK TEXT

    // BIB NUMBER
    if (bib) {
      ctx.font = "bold 90px 'Anton'";
      ctx.fillText(`BIB ${bib}`, 80, 430);
    }

    // NAME
    if (displayName) {
      ctx.font = "bold 70px 'Anton'";
      ctx.fillText(displayName, 80, 520);
    }

    // RUNNER IMAGE
    if (photoInput) {
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          // LOWERED IMAGE POSITION
          ctx.drawImage(
            img,
            560,   // X
            520,   // Y (lower than before)
            420,   // Width
            520    // Height
          );
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(photoInput);
    }
  }
}
</script>

</body>
</html>
